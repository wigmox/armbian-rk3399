name: Z1-build-one

on:
  workflow_dispatch:
    inputs:

      board:
        description: 'è®¾å¤‡å‹å·'
        required: true
        type: choice
        options:
          - fine3399
          - firefly-rk3399
          - rk-sapphire
          - rock-4b
          - nanopim4v2
          - nanopct4
          - fmx1
          - aio-3399c-ai
          - verypc-d039
          - yskj
          - dg3399
        default: "aio-3399c-ai"

      version:
        description: 'Armbian ç‰ˆæœ¬'
        required: true
        type: choice
        options:
          - v24.11
          - v25.02
          - v25.05
          - v25.8.0-trunk.460
          - v25.11.0-trunk.3
          - main
        default: v25.02

      branch:
        description: 'ç³»ç»Ÿåˆ†æ”¯'
        required: true
        type: choice
        options:
          - current
          - edge
          - vendor
        default: current

      release:
        description: 'é€‰æ‹©ç³»ç»Ÿç‰ˆæœ¬'
        required: true
        type: choice
        options:
          - 'Debian11 ğŸ¯ >> Bullseye'
          - 'Debian12 ğŸ“š >> Bookworm'
          - 'Debian13 ğŸª >> Trixie'
          - 'Ubuntu22.04 ğŸª¼ >> Jammy'
          - 'Ubuntu24.04 ğŸœ >> Noble'
          - 'Ubuntu25.04 ğŸ§ >> Plucky'
        default: 'Debian12 ğŸ“š >> Bookworm'

      system:
        description: 'ç³»ç»Ÿç±»å‹'
        required: true
        type: choice
        options:
          - minimal
          - server
          - desktop
        default: minimal

      desktop:
        description: 'æ¡Œé¢ç±»å‹ï¼ˆå¦‚æœç³»ç»Ÿç±»å‹é€‰æ‹©æ¡Œé¢ï¼‰'
        required: false
        type: choice
        options:
          - xfce
          - cinnamon
          - gnome
          - i3-wm
        default: xfce

      bspfreeze:
        description: 'å†»ç»“ BSP'
        required: false
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'yes'

      rootfs:
        description: 'ROOTFS åˆ†åŒºæ ¼å¼'
        required: false
        type: choice
        options:
          - ext4
          - btrfs
        default: btrfs

      vendor:
        description: 'æºç æ”¯æŒ'
        required: false
        type: choice
        options:
          - Armbian
          - Armbian-unofficial
        default: Armbian

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:

      - name: åˆå§‹åŒ–ä¿¡æ¯
        run: |
          sudo -E apt-get -y update
          sudo -E apt-get -y install neofetch
          neofetch --off --color_blocks off --stdout

          echo -e "\033[32mCPU info:\033[0m"
          lscpu

          echo -e "\033[32mMemory info:\033[0m"
          free -h

          echo -e "\033[32mDisk space info:\033[0m"
          df -hT ${PWD}

          echo "æ¸…ç†å‰çš„ç£ç›˜ç©ºé—´:"
          df -h
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/lib/android/sdk/ndk
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo apt-get clean
          echo "æ¸…ç†åçš„ç£ç›˜ç©ºé—´:"
          df -h

      - name: æ¸…ç†å¹¶å®‰è£…ç¼–è¯‘ç¯å¢ƒ
        run: |
          sudo -E apt-get -y update
          export DEBIAN_FRONTEND=noninteractive
          sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* || true
          sudo -E apt-get -y install btrfs-progs tzdata $(curl -fsSL https://tinyurl.com/ubuntu2204-build-armbian)
          sudo -E systemctl daemon-reload
          # sudo -E apt-get -y full-upgrade
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean
          # echo åŠ è½½ Btrfs å†…æ ¸æ¨¡å—
          sudo modprobe btrfs
          # echo ç¡®è®¤æ¨¡å—å·²åŠ è½½
          lsmod | grep btrfs
          # echo æ£€æŸ¥å†…æ ¸æ˜¯å¦æ”¯æŒ
          grep BTRFS /boot/config-$(uname -r)
          sudo timedatectl set-timezone "$TZ"

      - name: æ£€å‡ºç›®æ ‡
        uses: actions/checkout@v5

      - name: æ£€å‡º Armbian æºç 
        run: |
          git clone -q --single-branch --depth=1 --branch=${{ inputs.version }} https://github.com/armbian/build.git

      - name: å¤åˆ¶ USERPATCHES å†…å®¹åˆ°æºç æ ¹ç›®å½•
        run: |
          cp -rvf userpatches build/
          # ä¿®æ”¹rootfs åˆ†åŒºä½ç½®
          # sed -i 's|setenv rootdev "/dev/mmcblk0p1"|setenv rootdev "/dev/mmcblk0p2"|g' build/config/bootscripts/boot-rockchip.cmd
          # ä¿®æ”¹æ—¥å¿—ç­‰çº§ä¸ºæœ€é«˜
          sed -i 's/\bverbosity=1\b/verbosity=7/g' build/config/bootenv/rockchip64.txt
          # cp -f rockchip64_common.inc.txt build/config/sources/families/include/rockchip64_common.inc
          # sed -i 's|https://github.com/armbian/rkbin|https://github.com/wingonwu/rkbin|g' build/extensions/rkbin-tools.sh
          # grep 'wingonwu/rkbin' build/extensions/rkbin-tools.sh

      - name: è®¾ç½®ç³»ç»Ÿç±»å‹
        env:
          DESKTOP_APPGROUPS: "browsers chat desktop_tools editors email internet multimedia office programming remote_desktop"
        run: |
          if [ "${{ inputs.system }}" == "minimal" ]; then
            echo "Setting up for minimal system..."
            SYSTEM_ARGS="BUILD_DESKTOP=no BUILD_MINIMAL=yes"
          elif [ "${{ inputs.system }}" == "server" ]; then
            echo "Setting up for server system..."
            SYSTEM_ARGS="BUILD_DESKTOP=no BUILD_MINIMAL=no"
          elif [ "${{ inputs.system }}" == "desktop" ]; then
            echo "Setting up for desktop system..."
            SYSTEM_ARGS="BUILD_DESKTOP=yes BUILD_MINIMAL=no DESKTOP_ENVIRONMENT=${{ inputs.desktop }} \
                  DESKTOP_ENVIRONMENT_CONFIG_NAME=config_base \
                  DESKTOP_APPGROUPS_SELECTED=\"${{ env.DESKTOP_APPGROUPS }}\""
          fi
          echo "BUILD_ARGS=$SYSTEM_ARGS" >> $GITHUB_ENV

      - name: æ˜¾ç¤ºé€‰æ‹©æ‰€è¦ç¼–è¯‘çš„çš„ç³»ç»Ÿç±»å‹
        run: |
          echo "env.BUILD_ARGS: ${{ env.BUILD_ARGS }}"
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: æå–ç³»ç»Ÿä»£å·
        run: |
          # ä½¿ç”¨awkæå–æœ€åä¸€ä¸ª>>ä¹‹åçš„éƒ¨åˆ†
          RELEASE_CODE=$(echo "${{ inputs.release }}"  | awk -F'>>' '{gsub(/^[ \t]+|[ \t]+$/, "", $2); print tolower($2)}')
          # å¦‚æœæ²¡æœ‰>>ï¼Œåˆ™ä½¿ç”¨æ•´ä¸ªå­—ç¬¦ä¸²ï¼ˆé˜²æ­¢é”™è¯¯ï¼‰
          if [ -z "$RELEASE_CODE" ]; then
          RELEASE_CODE="${{ inputs.release }}"
          fi
          echo "release_code=$RELEASE_CODE" >> $GITHUB_ENV

      - name: æ˜¾ç¤ºç³»ç»Ÿä»£å·
        run: |
          echo "env.release_code: ${{ env.release_code }}"

      - name: ç¼–è¯‘ [ ${{ inputs.version }} - ${{ inputs.board }} - ${{ inputs.release }} - ${{ inputs.branch }} - ${{ inputs.system }} - ${{ inputs.rootfs }} ]
        run: |
          pushd build
          bash ./compile.sh build BOARD=${{ inputs.board }} \
          BRANCH=${{ inputs.branch }} \
          ${{ env.BUILD_ARGS }} \
          KERNEL_CONFIGURE=no \
          RELEASE=${{ env.release_code }} \
          COMPRESS_OUTPUTIMAGE=sha,img,xz \
          BSPFREEZE=${{ inputs.bspfreeze }} \
          ROOTFS_TYPE=${{ inputs.rootfs }} \
          VENDOR=${{ inputs.vendor }}
          popd

      - name: æ˜¾ç¤ºå‰©ä½™ç©ºé—´
        run: |
          df -hT ${PWD}

      - name: æ˜¾ç¤ºé•œåƒ
        run: |
          ls -lh ${{ github.workspace }}/build/output/images
          echo "buildtime=$(date +"%Y.%m.%d.%H.%M")" >> $GITHUB_ENV

      - name: ä¸Šä¼ é•œåƒ
        uses: ncipollo/release-action@main
        if: success()
        with:
          tag: "${{ inputs.vendor }}_${{ inputs.version }}_${{ env.release_code }}_${{ inputs.branch }}_${{ inputs.system }}_b${{ env.buildtime }}"
          artifacts: "${{ github.workspace }}/build/output/images/*"
          allowUpdates: true
          removeArtifacts: false
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ### ğŸ’¿ Armbian é•œåƒä¿¡æ¯
            - ğŸ’» Armbian ç‰ˆæœ¬: ${{ inputs.release }}
            - ğŸ–¥ ç³»ç»Ÿåˆ†æ”¯ï¼š${{ inputs.branch }}
            - ğŸ—‚ æºç : https://github.com/armbian/build.git
            - ğŸ”– æºç åˆ†æ”¯: ${{ inputs.version }}
            - â±ï¸ ç¼–è¯‘æ—¶é—´: ${{ env.buildtime }}
            - ğŸ’½ ROOTFS æ ¼å¼: ${{ inputs.rootfs }}
            ### âš™ è®¾ç½®ä¿¡æ¯
            - ğŸ‘¤ é»˜è®¤ç”¨æˆ·å:  root
            - ğŸ”’ é»˜è®¤å¯†ç :  1234
            - âŒ¨ ä¿®æ”¹ apt æº: armbian-apt
            - âŒ¨ é…ç½®å‘½ä»¤: armbian-config
            - âŒ¨ å‡çº§å‘½ä»¤: armbian-upgrade
            - âŒ¨ å®‰è£…å‘½ä»¤: armbian-install 
          draft: false
          prerelease: false

      - name: æ¸…ç† releases å’Œ workflows
        uses: ophub/delete-releases-workflows@main
        with:
          delete_releases: true                  # æ¸…ç†releaseså¼€å…³ï¼Œå¿…é¡»å­˜åœ¨ï¼Œå¦‚æœä¸å¼€å°±å†™false
          prerelease_option: all                 # è®¾ç½®æ¸…ç†releasesæ˜¯å¦åŒºåˆ†é¢„å‘è¡Œç‰ˆæœ¬
          # releases_keep_keyword: targz/Update    # æ¸…ç†releasesæ—¶å€™ä¿ç•™å…³é”®å­—ç¬¦åç§°çš„tagsä¸æ¸…ç†ï¼ˆtargz/Update æ”¹æˆä½ éœ€è¦çš„å…³é”®å­—ç¬¦,ä¸éœ€è¦çš„å°±ä¸é™„åŠ æ­¤é¡¹ï¼‰
          releases_keep_latest: 10               # æ¸…ç†releasesæ—¶å€™æ’é™¤å…³é”®å­—ç¬¦tagså¤–ï¼Œå†ä¿ç•™Nä¸ªæ—¶é—´é å‰çš„å‘å¸ƒä¸æ¸…ç†
          delete_tags: true                      # æ¸…ç†releasesæ—¶å€™æ¸…ç†tagsï¼Œä¸€èˆ¬éƒ½å¼€å¯åŒæ­¥æ¸…ç†çš„
          max_releases_fetch: 200                # ä¸€æ¬¡æœ€å¤šæ£€æŸ¥å¤šå°‘ä¸ªreleasesï¼Œè¿›è¡Œæ¸…ç†ï¼Œè®¾ç½®å¤ªå¤šçš„è¯ï¼Œæ¸…ç†æ—¶é—´è¿‡é•¿ï¼Œæˆ–è€…ä¼šå‡ºç°è¶…æ—¶æƒ…å†µï¼ŒæŒ‰100å€æ•°å¢åŠ ï¼Œæœ€é«˜å¯ä»¥è®¾ç½®1000ï¼ˆæ¯”å¦‚100ã€200ã€300...800ã€900ã€1000ï¼‰

          delete_workflows: true                # æ¸…ç†workflowså¼€å…³ï¼Œå¿…é¡»å­˜åœ¨ï¼Œå¦‚æœä¸å¼€å°±å†™false
          # workflows_keep_keyword: lede          # æ¸…ç†workflowsæ—¶å€™ä¿ç•™å…³é”®å­—ç¬¦åç§°çš„runsä¸æ¸…ç†ï¼ˆlede æ”¹æˆä½ éœ€è¦çš„å…³é”®å­—ç¬¦,ä¸éœ€è¦çš„å°±ä¸é™„åŠ æ­¤é¡¹ï¼‰
          workflows_keep_latest: 10             # æ¸…ç†workflowsæ—¶å€™æ’é™¤å…³é”®å­—ç¬¦runså¤–ï¼Œå†ä¿ç•™Nä¸ªæ—¶é—´é å‰çš„runsä¸æ¸…ç†
          max_workflows_fetch: 200              # ä¸€æ¬¡æœ€å¤šæ£€æŸ¥å¤šå°‘ä¸ªworkflowsï¼Œè¿›è¡Œæ¸…ç†ï¼Œè®¾ç½®å¤ªå¤šçš„è¯ï¼Œæ¸…ç†æ—¶é—´è¿‡é•¿ï¼Œæˆ–è€…ä¼šå‡ºç°è¶…æ—¶æƒ…å†µï¼ŒæŒ‰100å€æ•°å¢åŠ ï¼Œæœ€é«˜å¯ä»¥è®¾ç½®1000ï¼ˆæ¯”å¦‚100ã€200ã€300...800ã€900ã€1000ï¼‰
          repo: ${{ github.repository }}        # æ¸…ç†ä»“åº“è®¾ç½®ï¼Œé»˜è®¤ä¸ºæ‚¨å¯åŠ¨æœ¬ç¨‹åºçš„è‡ªèº«ä»“åº“
          gh_token: ${{ secrets.GITHUB_TOKEN }}   # GITHUB_TOKENï¼Œä»“åº“å¯†åŒ™ï¼Œå¿…é¡»å­˜åœ¨

