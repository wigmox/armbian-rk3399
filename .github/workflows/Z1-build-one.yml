name: Z1-build-one

on:
  workflow_dispatch:
    inputs:

      rkdevflash:
        description: 'ç¼–è¯‘ Rockchip ä¸“å±çº¿åˆ·é•œåƒ'
        required: false
        type: boolean
        default: false

      board:
        description: 'è®¾å¤‡å‹å·'
        required: true
        type: choice
        options:
          - fine3399
          - firefly-rk3399
          - rk-sapphire
          - rock-4b
          - nanopim4v2
          - nanopct4
          - fmx1
          - aio-3399c-ai
          - verypc-d039
          - yskj
          - dg3399
        default: "aio-3399c-ai"

      version:
        description: 'Armbian ç‰ˆæœ¬ (å¸¦ .y åŒ¹é…æœ€æ–° tag)'
        required: true
        type: choice
        options:
          - v24.11
          - v25.02
          - v25.2.y
          - v25.5.y
          - v25.8.y
          - v25.11.y
          - main
        default: v25.11.y

      branch:
        description: 'ç³»ç»Ÿåˆ†æ”¯'
        required: true
        type: choice
        options:
          - current
          - edge
          - vendor
        default: current

      release:
        description: 'é€‰æ‹©ç³»ç»Ÿç‰ˆæœ¬'
        required: true
        type: choice
        options:
          - 'Debian11 ğŸ¯ >> Bullseye'
          - 'Debian12 ğŸ“š >> Bookworm'
          - 'Debian13 ğŸª >> Trixie'
          - 'Ubuntu22.04 ğŸª¼ >> Jammy'
          - 'Ubuntu24.04 ğŸœ >> Noble'
          - 'Ubuntu25.04 ğŸ§ >> Plucky'
        default: 'Debian12 ğŸ“š >> Bookworm'

      system:
        description: 'ç³»ç»Ÿç±»å‹'
        required: true
        type: choice
        options:
          - minimal
          - server
          - desktop-xfce
          - desktop-cinnamon
          - desktop-gnome
          - desktop-i3-wm
        default: minimal

      bspfreeze:
        description: 'å†»ç»“ BSP'
        required: false
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'yes'

      rootfs:
        description: 'ROOTFS åˆ†åŒºæ ¼å¼'
        required: false
        type: choice
        options:
          - ext4
          - btrfs
        default: btrfs

      extrawifi:
        description: 'ç¼–è¯‘ WIFI é©±åŠ¨'
        required: false
        type: choice
        options:
          - 'yes'
          - 'no'
        default: 'yes'

      vendor:
        description: 'æºç æ”¯æŒ'
        required: false
        type: choice
        options:
          - Armbian
          - Armbian-unofficial
        default: Armbian

env:
  TZ: Asia/Shanghai
  REPO_URL: https://github.com/armbian/build.git

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:

      - name: æ£€å‡ºç›®æ ‡
        uses: actions/checkout@v5

      - name: åˆ¤æ–­è¦ä½¿ç”¨çš„ Armbian ç‰ˆæœ¬
        id: version_selector
        run: |
          USER_CHOICE="${{ inputs.version }}"
          ARMBIAN_VERSION=""

          # åˆ¤æ–­ç”¨æˆ·é€‰æ‹©çš„æ˜¯å¦æ˜¯åŠ¨æ€ç‰ˆæœ¬ (ä»¥ .y ç»“å°¾)
          if [[ "$USER_CHOICE" == *.y ]]; then
            # ç§»é™¤ .y åç¼€ï¼Œå¾—åˆ°ç‰ˆæœ¬å‰ç¼€, e.g., "v25.8"
            VERSION_PREFIX=$(echo "$USER_CHOICE" | sed 's/\.y$//')
            echo "ç”¨æˆ·é€‰æ‹©äº†åŠ¨æ€ç‰ˆæœ¬ï¼Œå¼€å§‹æŸ¥æ‰¾å‰ç¼€ä¸º ${VERSION_PREFIX} çš„æœ€æ–° tag..."

            # ä» Armbian è¿œç¨‹ä»“åº“è·å–æ‰€æœ‰ tagsï¼Œå¹¶æŒ‰ç‰ˆæœ¬å·é€†åºæ’åº (æœ€æ–°ç‰ˆæœ¬åœ¨æœ€å‰é¢)
            # ä½¿ç”¨ `git ls-remote` å¯ä»¥åœ¨ä¸å…‹éš†æ•´ä¸ªä»“åº“çš„æƒ…å†µä¸‹è·å– tagsï¼Œé€Ÿåº¦éå¸¸å¿«
            ALL_TAGS=$(git ls-remote --tags --sort='-v:refname' $REPO_URL)

            # 1. ä¼˜å…ˆæŸ¥æ‰¾ç¨³å®šç‰ˆ (ä¸å« "trunk")
            # æ ¼å¼ç±»ä¼¼: v25.8.1
            LATEST_STABLE_TAG=$(echo "${ALL_TAGS}" | grep "refs/tags/${VERSION_PREFIX}" | grep -v "trunk" | head -n 1 | sed 's/.*\///')
            
            if [[ -n "$LATEST_STABLE_TAG" ]]; then
              ARMBIAN_VERSION="$LATEST_STABLE_TAG"
              echo "æ‰¾åˆ°æœ€æ–°çš„ç¨³å®šç‰ˆ tag: ${ARMBIAN_VERSION}"
            else
              # 2. å¦‚æœæ²¡æœ‰ç¨³å®šç‰ˆï¼Œåˆ™æŸ¥æ‰¾æœ€æ–°çš„ trunk ç‰ˆ
              # æ ¼å¼ç±»ä¼¼: v25.8.0-trunk.1, v25.8.0-trunk.2
              echo "æœªæ‰¾åˆ° ${VERSION_PREFIX} ç³»åˆ—çš„ç¨³å®šç‰ˆï¼Œå¼€å§‹æŸ¥æ‰¾æœ€æ–°çš„ trunk ç‰ˆ..."
              LATEST_TRUNK_TAG=$(echo "${ALL_TAGS}" | grep "refs/tags/${VERSION_PREFIX}" | grep "trunk" | head -n 1 | sed 's/.*\///')

              if [[ -n "$LATEST_TRUNK_TAG" ]]; then
                ARMBIAN_VERSION="$LATEST_TRUNK_TAG"
                echo "æ‰¾åˆ°æœ€æ–°çš„ trunk ç‰ˆ tag: ${ARMBIAN_VERSION}"
              else
                echo "::error:: æ— æ³•ä¸ºå‰ç¼€ ${VERSION_PREFIX} æ‰¾åˆ°ä»»ä½•åŒ¹é…çš„ tagï¼"
                exit 1
              fi
            fi
          else
            # å¦‚æœç”¨æˆ·é€‰æ‹©çš„æ˜¯ä¸€ä¸ªå›ºå®šç‰ˆæœ¬ (å¦‚ v24.11 æˆ– main)ï¼Œç›´æ¥ä½¿ç”¨
            ARMBIAN_VERSION="$USER_CHOICE"
            echo "ç”¨æˆ·é€‰æ‹©äº†å›ºå®šç‰ˆæœ¬: ${ARMBIAN_VERSION}"
          fi

          # å°†æœ€ç»ˆç¡®å®šçš„ç‰ˆæœ¬å·è¾“å‡ºåˆ° GITHUB_ENVï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "armbian_version=${ARMBIAN_VERSION}" >> $GITHUB_ENV


      - name: æ£€å‡º Armbian æºç 
        run: |
          git clone -q --single-branch --depth=1 --branch=${{ env.armbian_version }} $REPO_URL

      - name: è®¾ç½®ç³»ç»Ÿç±»å‹
        env:
          DESKTOP_APPGROUPS: "browsers chat desktop_tools editors email internet multimedia office programming remote_desktop"
          
        run: |
          INPUTS_SYSTEM="${{ inputs.system }}"

          # æ£€æŸ¥è¾“å…¥æ˜¯å¦ä»¥ "desktop-" å¼€å¤´
          if [[ "$INPUTS_SYSTEM" == desktop-* ]]; then
            echo "è®¾ç½®æ¡Œé¢ç±»å‹"
            # ä½¿ç”¨ sed å‘½ä»¤æ¥åˆ é™¤ "desktop-" å‰ç¼€
            # DESKTOP_NAME=$(echo "$INPUTS_SYSTEM" | sed 's/^desktop-//' || echo "")
            DESKTOP_NAME=$(echo "${{ inputs.system }}"  | awk -F'desktop-' '{gsub(/^[ \t]+|[ \t]+$/, "", $2); print tolower($2)}')
            echo "æ¡Œé¢ç±»å‹: ${DESKTOP_NAME}"
            # ä½¿ç”¨æå–å‡ºçš„æ¡Œé¢åç§°åŠ¨æ€æ„å»ºå‚æ•°å­—ç¬¦ä¸²
            SYSTEM_ARGS="BUILD_DESKTOP=yes \
                  BUILD_MINIMAL=no \
                  DESKTOP_ENVIRONMENT=${DESKTOP_NAME} \
                  DESKTOP_ENVIRONMENT_CONFIG_NAME=config_base \
                  DESKTOP_APPGROUPS_SELECTED=\"${{ env.DESKTOP_APPGROUPS }}\""
          # éæ¡Œé¢ç‰ˆ
          elif [ "${{ inputs.system }}" == "minimal" ]; then
            echo "Setting up for minimal system..."
            SYSTEM_ARGS="BUILD_DESKTOP=no \
            BUILD_MINIMAL=yes"
          elif [ "${{ inputs.system }}" == "server" ]; then
            echo "Setting up for server system..."
            SYSTEM_ARGS="BUILD_DESKTOP=no \
            BUILD_MINIMAL=no"
          fi
          echo "BUILD_ARGS=$SYSTEM_ARGS" >> $GITHUB_ENV
          # echo "BUILD_ARGS=$(printf %q "$SYSTEM_ARGS")" >> $GITHUB_ENV

      - name: æ˜¾ç¤ºé€‰æ‹©æ‰€è¦ç¼–è¯‘çš„çš„ç³»ç»Ÿç±»å‹
        run: |
          echo "env.BUILD_ARGS: ${{ env.BUILD_ARGS }}"
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: æå–ç³»ç»Ÿä»£å·
        run: |
          # ä½¿ç”¨awkæå–æœ€åä¸€ä¸ª>>ä¹‹åçš„éƒ¨åˆ†
          RELEASE_CODE=$(echo "${{ inputs.release }}"  | awk -F'>>' '{gsub(/^[ \t]+|[ \t]+$/, "", $2); print tolower($2)}')
          # å¦‚æœæ²¡æœ‰>>ï¼Œåˆ™ä½¿ç”¨æ•´ä¸ªå­—ç¬¦ä¸²ï¼ˆé˜²æ­¢é”™è¯¯ï¼‰
          if [ -z "$RELEASE_CODE" ]; then
          RELEASE_CODE="${{ inputs.release }}"
          fi
          echo "release_code=$RELEASE_CODE" >> $GITHUB_ENV

      - name: æ˜¾ç¤ºç³»ç»Ÿä»£å·
        run: |
          echo "env.release_code: ${{ env.release_code }}"

      - name: ç¼–è¯‘ Rockchip ä¸“å±çº¿åˆ·é•œåƒ
        if: ${{ inputs.rkdevflash }} # ç›´æ¥åœ¨ step çº§åˆ«åˆ¤æ–­
        run: |
        
          sed -i '/BL31_BLOB="${BL31_BLOB:-"rk33\/rk3399_bl31_.*\.elf"}"$/a\ROCKUSB_BLOB="${MINILOADER_BLOB}"' build/config/sources/families/include/rockchip64_common.inc
          # sed -i '/BL31_BLOB="${BL31_BLOB:-"rk33\/rk3399_bl31_v1.35.elf"}"$/a\ROCKUSB_BLOB="${MINILOADER_BLOB}"' build/config/sources/families/include/rockchip64_common.inc
          # sed -i '\@BL31_BLOB="${BL31_BLOB:-"rk33/rk3399_bl31_v1.35.elf"}"$@a\ROCKUSB_BLOB="${MINILOADER_BLOB}"' build/config/sources/families/include/rockchip64_common.inc
          
          grep -E '^BL31_BLOB=|^ROCKUSB_BLOB=|^MINILOADER_BLOB=' build/config/sources/families/include/rockchip64_common.inc
          EXT_FLAG="EXT=rkdevflash"
          DOCKER_NO="PREFER_DOCKER=no"
          echo "EXT_FLAG=$EXT_FLAG" >> $GITHUB_ENV
          echo "DOCKER_NO=$DOCKER_NO" >> $GITHUB_ENV

      - name: æ˜¾ç¤ºç¯å¢ƒå˜é‡
        run: |
          echo "env.EXT_FLAG: ${{ env.EXT_FLAG }}"
          echo "env.DOCKER_NO: ${{ env.DOCKER_NO }}"
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: åˆå§‹åŒ–ä¿¡æ¯
        run: |
          sudo -E apt-get -y update
          sudo -E apt-get -y install neofetch
          neofetch --off --color_blocks off --stdout

          echo -e "\033[32mCPU info:\033[0m"
          lscpu

          echo -e "\033[32mMemory info:\033[0m"
          free -h

          echo -e "\033[32mDisk space info:\033[0m"
          df -hT ${PWD}

          echo "æ¸…ç†å‰çš„ç£ç›˜ç©ºé—´:"
          df -h
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/lib/android/sdk/ndk
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo apt-get clean
          echo "æ¸…ç†åçš„ç£ç›˜ç©ºé—´:"
          df -h

      - name: æ¸…ç†å¹¶å®‰è£…ç¼–è¯‘ç¯å¢ƒ
        run: |
          sudo -E apt-get -y update
          export DEBIAN_FRONTEND=noninteractive
          sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* || true
          sudo -E apt-get -y install btrfs-progs tzdata $(curl -fsSL https://tinyurl.com/ubuntu2204-build-armbian)
          sudo -E systemctl daemon-reload
          # sudo -E apt-get -y full-upgrade
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean
          # echo åŠ è½½ Btrfs å†…æ ¸æ¨¡å—
          sudo modprobe btrfs
          # echo ç¡®è®¤æ¨¡å—å·²åŠ è½½
          lsmod | grep btrfs
          # echo æ£€æŸ¥å†…æ ¸æ˜¯å¦æ”¯æŒ
          grep BTRFS /boot/config-$(uname -r)
          sudo timedatectl set-timezone "$TZ"

      - name: å¤åˆ¶ USERPATCHES å†…å®¹åˆ°æºç æ ¹ç›®å½•
        run: |
          cp -rvf userpatches build/
          # cp -f rockchip64_common.inc.txt build/config/sources/families/include/rockchip64_common.inc
          # sed -i 's|https://github.com/armbian/rkbin|https://github.com/wingonwu/rkbin|g' build/extensions/rkbin-tools.sh
          # grep 'wingonwu/rkbin' build/extensions/rkbin-tools.sh

      - name: ç¼–è¯‘ [ ${{ env.armbian_version }} - ${{ inputs.board }} - ${{ inputs.release }} - ${{ inputs.branch }} - ${{ inputs.system }} - ${{ inputs.rootfs }} ]
        run: |
          pushd build
          bash ./compile.sh build BOARD=${{ inputs.board }} \
          BRANCH=${{ inputs.branch }} \
          ${{ env.BUILD_ARGS }} \
          KERNEL_CONFIGURE=no \
          RELEASE=${{ env.release_code }} \
          COMPRESS_OUTPUTIMAGE=sha,img,xz \
          BSPFREEZE=${{ inputs.bspfreeze }} \
          ROOTFS_TYPE=${{ inputs.rootfs }} \
          ${{ env.EXT_FLAG }} \
          ${{ env.DOCKER_NO }} \
          VENDOR=${{ inputs.vendor }} \
          EXTRAWIFI=${{ inputs.extrawifi }} \
          IMAGE_XZ_COMPRESSION_RATIO=6
          SEVENZIP=yes
          NETWORKING_STACK=network-manager
          popd

      - name: æ˜¾ç¤ºå‰©ä½™ç©ºé—´
        run: |
          df -hT ${PWD}

      - name: æ˜¾ç¤ºé•œåƒ
        run: |
          ls -lh ${{ github.workspace }}/build/output/images
          echo "buildtime=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: ä¸Šä¼ é•œåƒ
        uses: ncipollo/release-action@main
        if: success()
        with:
          tag: "${{ inputs.vendor }}_${{ inputs.version }}_${{ env.release_code }}_${{ inputs.branch }}_${{ inputs.system }}_b${{ env.buildtime }}"
          artifacts: "${{ github.workspace }}/build/output/images/*"
          allowUpdates: true
          removeArtifacts: false
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ### ğŸ’¿ Armbian é•œåƒä¿¡æ¯
            - ğŸ’» è®¾å¤‡å‹å·:${{ inputs.board }}
            - ğŸ–¥ Armbian ç‰ˆæœ¬: ${{ inputs.release }}
            - ğŸ–¥ ç³»ç»Ÿåˆ†æ”¯ï¼š${{ inputs.branch }}
            - ğŸ—‚ æºç : https://github.com/armbian/build.git
            - ğŸ”– æºç åˆ†æ”¯: ${{ env.armbian_version }}
            - â±ï¸ ç¼–è¯‘æ—¶é—´: ${{ env.buildtime }}
            - ğŸ’½ ROOTFS æ ¼å¼: ${{ inputs.rootfs }}
            ### âš™ è®¾ç½®ä¿¡æ¯
            - ğŸ‘¤ é»˜è®¤ç”¨æˆ·å:  root
            - ğŸ”’ é»˜è®¤å¯†ç :  1234
            - âŒ¨ ä¿®æ”¹ apt æº: armbian-apt
            - âŒ¨ é…ç½®å‘½ä»¤: armbian-config
            - âŒ¨ å‡çº§å‘½ä»¤: armbian-upgrade
            - âŒ¨ å®‰è£…å‘½ä»¤: armbian-install 
          draft: false
          prerelease: false

      - name: æ¸…ç† releases å’Œ workflows
        uses: ophub/delete-releases-workflows@main
        with:
          delete_releases: true                  # æ¸…ç†releaseså¼€å…³ï¼Œå¿…é¡»å­˜åœ¨ï¼Œå¦‚æœä¸å¼€å°±å†™false
          prerelease_option: all                 # è®¾ç½®æ¸…ç†releasesæ˜¯å¦åŒºåˆ†é¢„å‘è¡Œç‰ˆæœ¬
          # releases_keep_keyword: targz/Update    # æ¸…ç†releasesæ—¶å€™ä¿ç•™å…³é”®å­—ç¬¦åç§°çš„tagsä¸æ¸…ç†ï¼ˆtargz/Update æ”¹æˆä½ éœ€è¦çš„å…³é”®å­—ç¬¦,ä¸éœ€è¦çš„å°±ä¸é™„åŠ æ­¤é¡¹ï¼‰
          releases_keep_latest: 10               # æ¸…ç†releasesæ—¶å€™æ’é™¤å…³é”®å­—ç¬¦tagså¤–ï¼Œå†ä¿ç•™Nä¸ªæ—¶é—´é å‰çš„å‘å¸ƒä¸æ¸…ç†
          delete_tags: true                      # æ¸…ç†releasesæ—¶å€™æ¸…ç†tagsï¼Œä¸€èˆ¬éƒ½å¼€å¯åŒæ­¥æ¸…ç†çš„
          delete_workflows: true                # æ¸…ç†workflowså¼€å…³ï¼Œå¿…é¡»å­˜åœ¨ï¼Œå¦‚æœä¸å¼€å°±å†™false
          # workflows_keep_keyword: lede          # æ¸…ç†workflowsæ—¶å€™ä¿ç•™å…³é”®å­—ç¬¦åç§°çš„runsä¸æ¸…ç†ï¼ˆlede æ”¹æˆä½ éœ€è¦çš„å…³é”®å­—ç¬¦,ä¸éœ€è¦çš„å°±ä¸é™„åŠ æ­¤é¡¹ï¼‰
          workflows_keep_day: 10             # æ¸…ç†workflowsæ—¶å€™æ’é™¤å…³é”®å­—ç¬¦runså¤–ï¼Œå†ä¿ç•™Nä¸ªæ—¶é—´é å‰çš„runsä¸æ¸…ç†
          repo: ${{ github.repository }}        # æ¸…ç†ä»“åº“è®¾ç½®ï¼Œé»˜è®¤ä¸ºæ‚¨å¯åŠ¨æœ¬ç¨‹åºçš„è‡ªèº«ä»“åº“
          gh_token: ${{ secrets.GITHUB_TOKEN }}   # GITHUB_TOKENï¼Œä»“åº“å¯†åŒ™ï¼Œå¿…é¡»å­˜åœ¨

